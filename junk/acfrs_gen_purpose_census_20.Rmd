---
title: "Joining ACFRs General Purpose Entities with Census data"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
options(scipen = 999)
library(tidyverse)
library(dplyr)
library(DT)
library(janitor)
```
# Tasks & Challenges 

* Entity names in the original Acfrs database are not obvious, i.e., does not always contain a certain word to indicate its government type (i.e., city, town, county, etc). Even some names contains a certain word such as "county", it actually a town.

*ACFRs data has government_id (which is called census_id in the ACFRs portal). This is government unit identifier, and is not geo_id that are often used in many census datasets.

Two points above constitute challenges when we need to 1) adding population field in acfrs data, and 2) sort out what type of entities are collected.

* Two main ways to solve the problems: 

- Use a "middle file" to link geo_id and government_ID
- Joining by names and states 

## Middle file with government_id and geo_id

Use this file to get geo_id into acfrs_general_purpose
```{r}
# sheet 3 includes all geo_id in sheet 1. 
  sheet3 <- rio::import(here::here("data", "City and Town Mapping.xlsx"), sheet = 3) %>%
  clean_names() %>% 
  select(government_id, inferred_geo_id, name, state_ab)  %>% 
  rename(geo_id = inferred_geo_id,  # Marc created INFERRED GEO_ID, which meant to be geoID
         state.abb = state_ab) %>% 
  mutate(name = str_to_lower(name)) %>% 
  
  mutate(name = str_remove_all(name, "(town of)|(city of)|(village of)"),
         name = str_trim(name))

# sheet 2 has some geo_id that sheet 3 doesn't.   
  sheet2 <- rio::import(here::here("data", "City and Town Mapping.xlsx"), sheet = 2) %>%
  clean_names() %>% 
  rename(popestimate2020 = total) %>% 
    mutate(state.name = str_extract(name, ",(.*)"),
           state.name = str_remove_all(state.name, ", "),
           name = str_remove_all(name, ",(.*)")) %>% 
    left_join(df_state) %>% # get state.abb
  
    mutate(government_id = "") %>% 
    select(government_id, geo_id, name, state.abb) %>% 
    
    mutate(name = str_to_lower(name),
             name = str_remove_all(name, "(city)|(town)$"))
    
governmentID_geoID <- rbind(sheet2, sheet3) %>% select(-name)

saveRDS(governmentID_geoID, "governmentID_geoID.RDS")
```


# ACFRs General Purpose 2020
```{r}
# step 1: get all general purpose entities in acfrs, most contains governmentID
acfrs_general_purpose_20 <- readRDS("data/data_from_dbsite_2020.RDS") %>% 
  filter(category == "General Purpose") %>% 
  select(-c(5:11, category, has_unconfirmed, component_unit_of_id)) %>% 

  rename(government_id = census_id,
         state.abb = state) %>% # census_id in Acfrs database is actually government_id
# some government_id in ACFRs has 13 characters-> need to add 0
  mutate(government_id = ifelse(str_length(government_id) < 14, paste0("0", government_id), government_id)) %>% 

  # step 2: join with the middle file to get geo_id into acfrs data
  left_join(governmentID_geoID, by = c("state.abb", "government_id")) %>% 
  
  # cleaning to match with names in census
  mutate(name = str_to_lower(name),
         name = str_remove_all(name, "(\\.)|(\\')"),
         # In LA, ACFRs of some parish titled "parish police jury" -> Geoff: these are counties ACFRs
         name = str_remove_all(name, "police jury"), 
         name = str_remove_all(name, " fiscal court"),
         name = str_trim(name)) %>% 
  
  mutate(name = case_when(name == "yakutat borough" & state.abb == "AK" ~ "yakutat city and borough",
                          name == "dona ana county" & state.abb == "NM" ~ "doÃ±a ana county", 
                          name == "st marys county" & state.abb == "MD" ~ "st mary's county",
                          name == "athens-clarke county" & state.abb == "GA" ~ "st mary's county",
                          name == "greeneville-greene county" & state.abb == "TN" ~ "greene county",
                          name == "sevierville-sevier county" & state.abb == "TN" ~ "sevier county",
                          name == "lynchburg_moore county" & state.abb == "TN" ~ "moore county",
                          name == "hartsville-trousdale county" & state.abb == "TN" ~ "trousdale county",
                          name == "nashville and davidson county" & state.abb == "TN" ~ "davidson county",
                          name == "lafayette city-parish consolidated government" & state.abb == "LA" ~ "lafayette parish",
                          TRUE ~ name)) %>% 
  
  # Step 3: extract geo_id part to map with census
  mutate(geo_id = str_extract(geo_id, "US(.*)"),
         geo_id = str_remove_all(geo_id, "US")) 
saveRDS(acfrs_general_purpose_20, "acfrs_general_purpose_20.RDS")
```

# States

```{r}
### States from ACFRS 2020
acfrs_state_2020 <- acfrs_general_purpose_20 %>% 
  filter(str_detect(name, "(state of)|(district of columbia)|(commonwealth)")) %>% 
  filter(!str_detect(name, "yap|kosrae")) %>% 
  filter(!str_detect(name, "(iowa single audit)|(puerto rico)")) %>% 
  mutate(name = str_remove_all(name, "(state of)|(commonwealth of)"),
         name = str_trim(name))

# state from census
census_state <- census_all %>% filter(sumlev == 40) %>% 
  select(state.abb, geo_id, popestimate2020, popestimate2021, popestimate2022)

### Joining acfrs states & census states: state_gov_2020
state_gov_2020 <- acfrs_state_2020 %>% select(-geo_id) %>% 
  left_join(census_state, by = c("state.abb")) %>% 
  select(-c(popestimate2021, popestimate2022, government_id)) 

state_gov_2020 %>% write.csv("output/state_gov_2020.csv")

state_gov_2020 %>% select(state.abb, name, id) %>%
saveRDS("state_acfrs_id.RDS")

saveRDS(state_gov_2020, "state_gov_2020.RDS")
```

# Counties

### Step 1: filter for counties from ACFRs
```{r}
acfrs_county_20 <- acfrs_general_purpose_20 %>% 
  filter(grepl("county|municipality|parish", name)) %>% #In Louisiana, counties are called Parishes.
  filter(!str_detect(name, "\\(")) # not county. Eg: waverly township (van buren county)

```

#### Step 2: Alaska

Although it says here Alaska has 29 equivalent counties: https://www.census.gov/geographies/reference-files/2010/geo/state-local-geo-guides-2010/alaska.html
In fact, when using Census 2020 & filter for SUMLEV = 050 (county gov), AK has 30 equivalent counties. 

Four consolidated governments, Anchorage, Juneau, Sitka, and Wrangell, which are classified as municipal governments + 11 census area + borough.

```{r}
# Alaska counties in Acfrs:
alaska_county_acfrs_20 <- acfrs_general_purpose_20 %>% 
  filter(state.abb == "AK") %>% 
  filter(str_detect(name, "(borough)$"))

# Double check: Compare with Alaska counties in census
alaska_county_census <- census_county %>% filter(state.abb == "AK") 

#NOTE: Both city and borough:
#"sitka city and borough", "wrangell city and borough", "yakutat city and borough", "juneau city and borough",
#others: "anchorage municipality",  "skagway municipality", 
```

### Step 3: Bind with Alaska  & Joining ACFRS counties with Census counties  
```{r}
# join acfrs with census population by = c("state.abb", "county")
county_gov_20 <- acfrs_county_20 %>% 
  rbind(alaska_county_acfrs_20) %>% 
  # most acfrs_county do not have geo_id --> must join by state.abb and name
  left_join(census_county, by = c("state.abb", "name")) %>% 
  
  # drop non-county entities
            arrange(desc(popestimate2020)) %>% # filter(is.na(popestimate2020)) # check non-county
            drop_na(popestimate2020) 

county_gov_20 %>% write.csv("output/county_gov_20.csv")

saveRDS(county_gov_20, "county_gov_20.RDS")

# Save county ID to filter in later years
county_gov_20 %>% select(state.abb, name, id) %>% saveRDS("county_acfrs_id_2020.RDS")
```

# Incorporated Place & Minor Division
```{r}
# ACFRs:
acfrs_incorporatedPlace_minorDivision <- acfrs_general_purpose_20 %>% 
  # exclude state and county
  filter(!id %in% acfrs_state_2020$id) %>% 
  filter(!id %in% county_gov_20$id) %>% distinct()

# Join Incorporated Place in ACFRs to Census  

incorp_division_gov_20 <- acfrs_incorporatedPlace_minorDivision %>% 
  left_join(census_incorporatedPlace_minorDivision, by= c("geo_id", "state.abb")) %>% 
  drop_na(popestimate2020)#%>% distinct(state.abb, name) # only 9146 distinct

saveRDS(incorp_division_gov_20, "incorp_division_gov_20.RDS")
# TODO: check inflated join result
 # census_incorporatedPlace_minorDivision %>% count(geo_id) %>% filter(n > 1) %>% arrange(desc(n))
 # census_incorporatedPlace_minorDivision %>% filter(geo_id %in% c("5589150", "5588150"))
```


## City

```{r}
# Acfrs cities do not always have the word "city" in their names. 
# step 2: filter from acfrs by geo_id
acfrs_incorporatedPlace_minorDivision %>% filter(geo_id %in% census_city$geo_id)

acfrs_incorporatedPlace_minorDivision %>% 
  left_join(census_100city) %>% arrange(desc(popestimate2020)) %>% select(state.abb, name, popestimate2020)
  
filter(geo_id %in% census_100city$geo_id) %>% arrange(desc(popestimate2020))
```

## Handle name differences between ACFRs entity name and census names. 
Oct 5: Queried data. Got these ones 
[1] "athens-clarke county"    ok                        
 [2] "greeneville-greene county" ok                       
 [3] "st marys county"             ok                    
 [4] "county"                        don't know which one is this                  
 [5] "sevierville-sevier county"           - fixed name to sevier county             
 [6] "lynchburg_moore county"               - fixed name to moore county          
 [7] "hartsville-trousdale county"          - fixed name to trousdale county       
 [8] "chisago hraeda county"             - recategorized on portal to special district              
 [9] "cleburne commission county"                      - not a county  
[10] "municipality of dell rapids"             - not a county        
[11] "washington commission county"              -CHECK with GEOFF: is this county ACFRs?       
[12] "lake annual county"                              - not a county     
[13] "cheokee county"       -   fixed name to cherokee on portal                        
[14] "hidalogo county"        - fixed name to hidalgo on poratal                 
[15] "metropolitan school districtwarren ecas county"  - deleted on portal
[16] "nashville and davidson county"       - fixed name to davidson county           
[17] "st clair county commission"              -CHECK with GEOFF: is this county ACFRs?         
[18] "metropolitan school district steuben ecas county" - deleted on poral
[19] "ashtabula metroparks county"                  - not county   
[20] "the ray county"                        - fixed name to ray county on portal          
[21] "kennecbec county"                  - fixed name to kennebec county              
[22] "ascension arceast ascension parish"  - not ACFRs, deleted            
[23] "st james executive committee republican parish"  
[24] "winn game and fish reserve saline lake parish"   
[25] "tangipahoa executive committee republican parish"
[26] "washington executive committee republican parish"
[27] "vermilion arc parish"                - not ACFRs, deleted                 
[28] "bossier executive committee republican parish"   
[29] "beauregard crime stoppers parish"                
[30] "ouachita executive committee republican parish"  
[31] "jefferson executive committee republican parish" 
[32] "tangipahoa executive committee democratic parish"
[33] "desoto parish" - fixed name to de soto parish

```{r}
# corresposding cences names to some consolidated entities in acfrs
acfrs_census_name <- tibble(state.abb = c("GA", "TN", "MD", "TN", "TN", "TN", "TN"),
      acfrs_name = c("athens-clarke county","greeneville-greene county", "st marys county", "sevierville-sevier county", "lynchburg_moore county", "hartsville-trousdale county", "nashville and davidson county"), 
       census_name = c("clarke", "greene county", "st mary's county", "sevier", "moore county", "trousdale county", "davidson county") )
#TN greeneville-greene county has id: 106898
#changed name to greene county --> not find its year 2022
acfrs_census_name
```
