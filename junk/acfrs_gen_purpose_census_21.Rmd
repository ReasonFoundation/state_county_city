---
title: "Joining ACFRs General Purpose Entities with Census data"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
options(scipen = 999)
library(tidyverse)
library(dplyr)
library(DT)
library(janitor)
```
The key for SUMLEV is as follows (SUB-EST2022.pdf):
040 = State
050 = County
061 = Minor Civil Division
071 = Minor Civil Division place part
157 = County place part
160 = State-place
162 = Incorporated place
170 = Consolidated city
172 = Consolidated city -- place within consolidated city

```{r}
census_all <- readRDS("census_all.RDS")

#Use this file to get geo_id into acfrs_general_purpose
governmentID_geoID <- readRDS("governmentID_geoID.RDS")
```


# ACFRs General Purpose 2021
```{r}
# step 1: get all general purpose entities in acfrs, most contains governmentID
acfrs_general_purpose_21 <- readRDS("data/data_from_dbsite_2021.RDS") %>% 
  filter(category == "General Purpose") %>% 
  select(-c(5:11, category, has_unconfirmed, component_unit_of_id)) %>% 

  rename(government_id = census_id,
         state.abb = state) %>% # census_id in Acfrs database is actually government_id
# some government_id in ACFRs has 13 characters-> need to add 0
  mutate(government_id = ifelse(str_length(government_id) < 14, paste0("0", government_id), government_id)) %>% 

  # step 2: join with the middle file to get geo_id into acfrs data
  left_join(governmentID_geoID, by = c("state.abb", "government_id")) %>% 
  
  # cleaning to match with names in census
  mutate(name = str_to_lower(name),
         name = str_remove_all(name, "(\\.)|(\\')"),
         # In LA, ACFRs of some parish titled "parish police jury" -> Geoff: these are counties ACFRs
         name = str_remove_all(name, "police jury"), 
         name = str_remove_all(name, " fiscal court"),
         name = str_trim(name)) %>% 
  
  mutate(name = case_when(name == "yakutat borough" & state.abb == "AK" ~ "yakutat city and borough",
                          name == "dona ana county" & state.abb == "NM" ~ "doÃ±a ana county", 
                          name == "st marys county" & state.abb == "MD" ~ "st mary's county",
                          name == "athens-clarke county" & state.abb == "GA" ~ "st mary's county",
                          name == "greeneville-greene county" & state.abb == "TN" ~ "greene county",
                          name == "sevierville-sevier county" & state.abb == "TN" ~ "sevier county",
                          name == "lynchburg_moore county" & state.abb == "TN" ~ "moore county",
                          name == "hartsville-trousdale county" & state.abb == "TN" ~ "trousdale county",
                          name == "nashville and davidson county" & state.abb == "TN" ~ "davidson county",
                          name == "lafayette city-parish consolidated government" & state.abb == "LA" ~ "lafayette parish",
                          TRUE ~ name)) %>% 
  
  # Step 3: extract geo_id part to map with census
  mutate(geo_id = str_extract(geo_id, "US(.*)"),
         geo_id = str_remove_all(geo_id, "US")) 

saveRDS(acfrs_general_purpose_21, "acfrs_general_purpose_21.RDS")
```


# States

```{r}
### States from ACFRS 2020
acfrs_state_2021 <- acfrs_general_purpose_21 %>% 
  filter(str_detect(name, "(state of)|(district of columbia)|(commonwealth)")) %>% 
  filter(!str_detect(name, "yap|kosrae")) %>% 
  filter(!str_detect(name, "(iowa single audit)|(puerto rico)")) %>% 
  mutate(name = str_remove_all(name, "(state of)|(commonwealth of)"),
         name = str_trim(name))

# state from census
census_state <- census_all %>% filter(sumlev == 40) %>% 
  select(state.abb, geo_id, popestimate2020, popestimate2021, popestimate2022)

### Joining acfrs states & census states: state_gov_2020
state_gov_2021 <- acfrs_state_2021 %>% select(-geo_id) %>% 
  left_join(census_state, by = c("state.abb")) %>% 
  select(-c(popestimate2020, popestimate2022, government_id)) 

state_gov_2021 %>% write.csv("output/state_gov_2021.csv")
saveRDS(state_gov_2021, "state_gov_2021.RDS")
```

# Counties

### Census counties

```{r}
census_county <- readRDS("census_county.RDS")
```

## Counties from ACFRs

### Step 1: filter for counties from ACFRs
```{r}
acfrs_county_21 <- acfrs_general_purpose_21 %>% 
  filter(grepl("county|municipality|parish", name)) %>% #In Louisiana, counties are called Parishes.
  filter(!str_detect(name, "\\(")) # not county. Eg: waverly township (van buren county)

```

#### Step 2: Alaska

Although it says here Alaska has 29 equivalent counties: https://www.census.gov/geographies/reference-files/2010/geo/state-local-geo-guides-2010/alaska.html
In fact, when using Census 2020 & filter for SUMLEV = 050 (county gov), AK has 30 equivalent counties. 

Four consolidated governments, Anchorage, Juneau, Sitka, and Wrangell, which are classified as municipal governments + 11 census area + borough.

```{r}
# Alaska counties in Acfrs:
alaska_county_acfrs_21 <- acfrs_general_purpose_21 %>% 
  filter(state.abb == "AK") %>% 
  filter(str_detect(name, "(borough)$"))

# Double check: Compare with Alaska counties in census
alaska_county_census <- census_county %>% filter(state.abb == "AK") %>% 
  filter(funcstat == "A")

#NOTE: Both city and borough:
#"sitka city and borough", "wrangell city and borough", "yakutat city and borough", "juneau city and borough",
#others: "anchorage municipality",  "skagway municipality", 
```

### Step 3: Bind with Alaska  & Joining ACFRS counties with Census counties  
```{r}
# join acfrs with census population by = c("state.abb", "county")
county_gov_21 <- acfrs_county_21 %>% 
  rbind(alaska_county_acfrs_21) %>% 
  # most acfrs_county do not have geo_id --> must join by state.abb and name
  left_join(census_county, by = c("state.abb", "name")) %>% 
  
  # drop non-county entities
            arrange(desc(popestimate2021)) %>% # filter(is.na(popestimate2020)) # check non-county
            drop_na(popestimate2021) 

county_gov_21 %>% write.csv("output/county_gov_21.csv")

saveRDS(county_gov_21, "county_gov_21.RDS")

# Save county ID to filter in later years
county_gov_21 %>% select(state.abb, name, id) %>% saveRDS("county_acfrs_id_2021.RDS")
```

# Incorporated Place & Minor Civil Division: 

```{r}
# ACFRs:
acfrs_incorporatedPlace_minorDivision_21 <- acfrs_general_purpose_21 %>% 
  # exclude state and county
  filter(!id %in% acfrs_state_2021$id) %>% 
  filter(!id %in% county_gov_21$id) %>% distinct()

# Census
census_incorporatedPlace_minorDivision <- census_all %>% 
  filter(sumlev %in% c(162, 061, 170, 172)) %>% 
  rename(name_census = name) %>% 
  distinct(sumlev, state.abb, geo_id, popestimate2021)

# Join Incorporated Place in ACFRs to Census  

incorp_division_gov_21 <- acfrs_incorporatedPlace_minorDivision_21 %>% 
  left_join(census_incorporatedPlace_minorDivision, by= c("geo_id", "state.abb")) %>% 
  drop_na(popestimate2021)#%>% distinct(state.abb, name) # only 9146 distinct

saveRDS(incorp_division_gov_21, "incorp_division_gov_21.RDS")
# TODO: check inflated join result
  
 # census_incorporatedPlace_minorDivision %>% count(geo_id) %>% filter(n > 1) %>% arrange(desc(n))
 # census_incorporatedPlace_minorDivision %>% filter(geo_id %in% c("5589150", "5588150"))
```

## City

```{r}
# Acfrs cities do not always have the word "city" in their names. 

#step 1: get census city list - 10,192 cities
census_city <- census_all %>% filter(sumlev == 162) %>% filter(str_detect(name, "city$"))

# step 2: filter from acfrs by geo_id
acfrs_incorporatedPlace_minorDivision %>% filter(geo_id %in% census_city$geo_id)
  
```



## Handle name differences between ACFRs entity name and census names. 
Oct 5: Queried data. Got these ones 
[1] "athens-clarke county"    ok                        
 [2] "greeneville-greene county" ok                       
 [3] "st marys county"             ok                    
 [4] "county"                        don't know which one is this                  
 [5] "sevierville-sevier county"           - fixed name to sevier county             
 [6] "lynchburg_moore county"               - fixed name to moore county          
 [7] "hartsville-trousdale county"          - fixed name to trousdale county       
 [8] "chisago hraeda county"             - recategorized on portal to special district              
 [9] "cleburne commission county"                      - not a county  
[10] "municipality of dell rapids"             - not a county        
[11] "washington commission county"              -CHECK with GEOFF: is this county ACFRs?       
[12] "lake annual county"                              - not a county     
[13] "cheokee county"       -   fixed name to cherokee on portal                        
[14] "hidalogo county"        - fixed name to hidalgo on poratal                 
[15] "metropolitan school districtwarren ecas county"  - deleted on portal
[16] "nashville and davidson county"       - fixed name to davidson county           
[17] "st clair county commission"              -CHECK with GEOFF: is this county ACFRs?         
[18] "metropolitan school district steuben ecas county" - deleted on poral
[19] "ashtabula metroparks county"                  - not county   
[20] "the ray county"                        - fixed name to ray county on portal          
[21] "kennecbec county"                  - fixed name to kennebec county              
[22] "ascension arceast ascension parish"  - not ACFRs, deleted            
[23] "st james executive committee republican parish"  
[24] "winn game and fish reserve saline lake parish"   
[25] "tangipahoa executive committee republican parish"
[26] "washington executive committee republican parish"
[27] "vermilion arc parish"                - not ACFRs, deleted                 
[28] "bossier executive committee republican parish"   
[29] "beauregard crime stoppers parish"                
[30] "ouachita executive committee republican parish"  
[31] "jefferson executive committee republican parish" 
[32] "tangipahoa executive committee democratic parish"
[33] "desoto parish" - fixed name to de soto parish

```{r}
# corresposding cences names to some consolidated entities in acfrs
acfrs_census_name <- tibble(state.abb = c("GA", "TN", "MD", "TN", "TN", "TN", "TN"),
      acfrs_name = c("athens-clarke county","greeneville-greene county", "st marys county", "sevierville-sevier county", "lynchburg_moore county", "hartsville-trousdale county", "nashville and davidson county"), 
       census_name = c("clarke", "greene county", "st mary's county", "sevier", "moore county", "trousdale county", "davidson county") )
#TN greeneville-greene county has id: 106898
#changed name to greene county --> not find its year 2022
acfrs_census_name
```
