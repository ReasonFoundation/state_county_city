---
title: "Joining ACFRs General Purpose Entities with Census data"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
options(scipen = 999)
library(tidyverse)
library(dplyr)
library(DT)
library(janitor)
```

# Census Data 2020

The key for SUMLEV is as follows (SUB-EST2022.pdf):
040 = State
050 = County
061 = Minor Civil Division
071 = Minor Civil Division place part
157 = County place part
160 = State-place
162 = Incorporated place
170 = Consolidated city
172 = Consolidated city -- place within consolidated city

```{r}
census_all <- readRDS("census_all.RDS")

# middle file sheet 3
governmentID_geoID <- readRDS("governmentID_geoID.RDS")
```


# ACFRs General Purpose 2022
```{r}
acfrs_general_purpose_22 <- readRDS("data/data_from_dbsite_2022.RDS") %>% 
  filter(category == "General Purpose") %>% 
  select(-c(5:11, category, has_unconfirmed, component_unit_of_id)) %>% 

  rename(government_id = census_id,
         state.abb = state) %>% # census_id in Acfrs database is actually government_id
# some government_id in ACFRs has 13 characters-> need to add 0
  mutate(government_id = ifelse(str_length(government_id) < 14, paste0("0", government_id), government_id)) %>% 

  # step 2: join with the middle file to get geo_id into acfrs data
  left_join(governmentID_geoID, by = c("state.abb", "government_id")) %>% 
  
  # cleaning to match with names in census
  mutate(name = str_to_lower(name),
         name = str_remove_all(name, "(\\.)|(\\')"),
         # In LA, ACFRs of some parish titled "parish police jury" -> Geoff: these are counties ACFRs
         name = str_remove_all(name, "police jury"), 
         name = str_remove_all(name, " fiscal court"),
         name = str_trim(name)) %>% 
  
  mutate(name = case_when(name == "yakutat borough" & state.abb == "AK" ~ "yakutat city and borough",
                          name == "dona ana county" & state.abb == "NM" ~ "doña ana county", 
                          name == "st marys county" & state.abb == "MD" ~ "st mary's county",
                          name == "athens-clarke county" & state.abb == "GA" ~ "st mary's county",
                          name == "greeneville-greene county" & state.abb == "TN" ~ "greene county",
                          name == "sevierville-sevier county" & state.abb == "TN" ~ "sevier county",
                          name == "lynchburg_moore county" & state.abb == "TN" ~ "moore county",
                          name == "hartsville-trousdale county" & state.abb == "TN" ~ "trousdale county",
                          name == "nashville and davidson county" & state.abb == "TN" ~ "davidson county",
                          name == "lafayette city-parish consolidated government" & state.abb == "LA" ~ "lafayette parish",
                          TRUE ~ name)) %>% 
  
  # Step 3: extract geo_id part to map with census
  mutate(geo_id = str_extract(geo_id, "US(.*)"),
         geo_id = str_remove_all(geo_id, "US"))  

```

# States

```{r}
### States from ACFRS 2022
acfrs_state_2022 <- acfrs_general_purpose_22 %>% 
  filter(str_detect(name, "(state of)|(district of columbia)|(commonwealth)")) %>% 
  filter(!str_detect(name, "yap|kosrae")) %>% 
  filter(!str_detect(name, "(iowa single audit)|(puerto rico)")) %>% 
  mutate(name = str_remove_all(name, "(state of)|(commonwealth of)"),
         name = str_trim(name))

# state from census
census_state <- census_all %>% filter(sumlev == 40) %>% 
  select(state.abb, geo_id, popestimate2020, popestimate2021, popestimate2022)

### Joining acfrs states & census states: state_gov_2020
state_gov_2022 <- acfrs_state_2022 %>% select(-geo_id) %>% 
  left_join(census_state, by = c("state.abb")) %>% 
  select(-c(popestimate2020, popestimate2021, government_id)) 


state_gov_2022 %>% write.csv("output/state_gov_2022.csv")
saveRDS(state_gov_2022, "state_gov_2022.RDS")
```

# Counties

```{r}
county_acfrs_id_2020 <- readRDS("county_acfrs_id_2020.RDS")
county_acfrs_id_2021 <- readRDS("county_acfrs_id_2021.RDS")
census_county <- readRDS("census_county.RDS")

#In counties 2021 but not in 2020
setdiff(county_acfrs_id_2021$name, county_acfrs_id_2020$name)

# bind all counties appeared in 2020 and 2021
county_acfrs_id_2020_2021 <- county_acfrs_id_2021 %>% 
  filter(!id %in% county_acfrs_id_2020$id) %>% 
  rbind(county_acfrs_id_2020)

county_gov_22 <- acfrs_general_purpose_22 %>% 
  filter(id %in% county_acfrs_id_2020_2021$id) %>% 
            left_join(census_county, by = c("state.abb", "name")) %>% #filter(str_detect(name, "st mary's county"))
            arrange((popestimate2022)) %>% #filter(is.na(popestimate2020))
            drop_na(popestimate2022) 

saveRDS(county_gov_22, "county_gov_22.RDS")

#test
county_pop_census_acfrs_22 %>% filter(str_detect(name, "kenai"))

```

# Incorporated Place & Minor Civil Division: 
From "Understanding Place in Census.pdf":
*Incorporated Places*
• Legally bounded entity
• Cities, boroughs, towns, or villages, depending on the state
• Over 19,000 incorporated places

Includes:
– Cities
– Towns (except in the six New England states, New York, and Wisconsin)
– Villages
– Boroughs (except in New York and Alaska)
Does not include:
– Towns/townships in the Northeast and Midwest

*Minor Civil Divisions (MCDs)*
• Legal entity in 29 states, DC, and Puerto Rico, and the Island Areas
• May have a formal government with elected officials
• Over 30,000 MCDs for the 2010 Census

*Consolidated Cities*:
Within each consolidated city, a “balance” entity is defined, encompassing the area of the original city and the area outside the “dependent” incorporated places


```{r}
# ACFRs:
acfrs_incorporatedPlace_minorDivision_22 <- acfrs_general_purpose_22 %>% 
  # exclude state and county
  filter(!id %in% acfrs_state_2020$id) %>% 
  filter(!id %in% county_gov_20$id) %>% distinct()

# Census
census_incorporatedPlace_minorDivision <- census_all %>% 
  filter(sumlev %in% c(162, 061, 170, 172)) %>% 
  rename(name_census = name) %>% 
  distinct(sumlev, state.abb, geo_id, popestimate2022)

# Join Incorporated Place in ACFRs to Census  

incorp_division_gov_22 <- acfrs_incorporatedPlace_minorDivision_22 %>% 
  left_join(census_incorporatedPlace_minorDivision, by= c("geo_id", "state.abb")) %>% 
  drop_na(popestimate2022)#%>% distinct(state.abb, name) # only 9146 distinct

saveRDS(incorp_division_gov_22, "incorp_division_gov_22.RDS")

# TODO: check inflated join result
  
 # census_incorporatedPlace_minorDivision %>% count(geo_id) %>% filter(n > 1) %>% arrange(desc(n))
 # census_incorporatedPlace_minorDivision %>% filter(geo_id %in% c("5589150", "5588150"))
```



