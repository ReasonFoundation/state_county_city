---
title: "Matching Census Population to ACFRs Data at County Level"
author: "TN"
date: January 28, 2022
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    toc_depth: 3
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(dplyr)
library(janitor)
```

# County Population from Census 

```{r}
df_state <- data.frame(state.abb, state.name)

census_county_2020 <-  rio::import(here::here("data", "sub-est2022.csv")) %>% 
   clean_names() %>% 
   filter(sumlev == 050) %>% 
  rename(population = popestimate2020,
           county_name = name,
           county_code = county,
           state.name = stname) %>% 
  select(county_code, state.name, county_name, population) %>% 
  filter(county_name != "District of Columbia") %>% 
  mutate(county_name = str_to_lower(county_name),
         county_name = str_remove(county_name,"\\.|'|‘")) %>% 
      left_join(df_state) # to get state.abb to join with acfrs data later. 

# Check special cases: 
census_county_2020 %>% 
  # 41 city entities categorized as county
  filter(!str_detect(county_name, "(borough)|(county)|(parish)|(planning regio)|(census area)|(municipality)")) 
# Note: Planning Regio, lacking "n" at last, to include all Planning Region in CT

#Louisiana has 64 entities "Parish"
# Alaska has 30 entities " 17 Borough", "Census Area", "Municipality"
# Connecticut has 9 entities "Planning Region"

nrow(census_county_2020)
```

```{r}
# Nashville-Davidson metropolitan government (balance) TN == "Nashville and Davidson County" TN in ACFRS--> rename to match
mutate(county = ifelse(county == "nashville-davidson metropolitan government (balance)" & state.abb == "TN", "nashville and davidson county", county)) %>%
# 
# # Louisville/Jefferson County metro government (balance) KY == Louisville-Jefferson County KY in ACFRs 
mutate(county = ifelse(county == "louisville/jefferson county metro government (balance)" & state.abb == "KY", "louisville-jefferson county", county))
```

There are `r nrow(pop_county)` observations in census population data.

# ACFRs data - County Level

```{r}
acfrs_generalpurpose_2020 <- readRDS("data/data_from_dbsite_2020.RDS") %>% #data updated July 21, 2023
              filter(category == "General Purpose") %>%
# normalize names 
  mutate(name = str_to_lower(name), 
         name = str_remove(name,"\\.|'|‘"),
         state.abb = state
         ) #%>% filter(county == "nashville and davidson county")
```
ACFRs general purpose 2020 category has `r nrow(acfrs_generalpurpose_2020)` observations. 


## Step 1: find entities whose names contain "County" or "Municipality" in ACFRs
```{r}
# ACFRs entities that contains the word "County" in their names
  acfrs_county <- acfrs_generalpurpose_2020 %>% 
  filter(grepl("county|municipality", name)) %>% 
  
  # correct some simple spelling errors
  mutate(name = case_when(name == "dona ana county" ~ "doña ana county", 
                          TRUE ~ name)) 
```

There are `r nrow(acfrs_county)` entities that contain the word "county" in their names. 

## Step 2: Special cases 
### Louisiana

In Louisiana, counties are called Parishes.

```{r}
louisiana_parish <- acfrs_generalpurpose_2020 %>% 
  filter(state.abb == "LA") %>% 
  filter(grepl("parish", name))
```
There're `r nrow(louisiana_parish)` Louisiana entities that contain the word "Parish" in their names. 

### Alaska
Census counts 30 counties under 3 types: Borough, Municipality, Census Area
Alaska often uses the term "Borough" instead of County. 
```{r}
# Get Alaska counties in census
alaska_county_census <- census_county_2020 %>% 
  filter(state.name == "Alaska") %>% 
  mutate(county_name = str_remove_all(county_name, "city and borough"), 
         county_name = str_remove_all(county_name, "(borough)|(census area)|(municipality)"),
         county_name = str_to_lower(county_name),
         county_name = str_squish(county_name))

#NOTE: Both city and borough:
#"sitka city and borough", "wrangell city and borough", "yakutat city and borough"
```

```{r}
# use the list of Alaska counties in census to find counties in acfrs:
alaska_borough_acfrs <- acfrs_generalpurpose_2020 %>% 
  filter(state.abb == "AK") %>% 
  mutate(name = str_remove_all(name, "borough"),
         name = str_to_lower(name),
         name = str_squish(name)) %>% 

  filter(name %in% alaska_county_census$county_name) %>% arrange(name)

```

# Join ACFRs and Census County Population 

Joining these components: 

*acfrs entities contain word "County" or "Municipality" in their names

*acfrs entities of Louisiana that contain word "Parish" in their names

*acfrs entities of Alaska that contain word "Borough" in their names


```{r}
# first, join entities in ACFRs contain words "County" + Louisiana that contain word "Parish" + alaska that contain "Borough" in their names
acfrs_county_parish_borough <- rbind(acfrs_county, louisiana_parish) %>% 
                              rbind(alaska_borough_acfrs) %>% 
  rename(county_name = name) %>% 
  
  # cleaning to match with names in census
  mutate(county_name = str_remove_all(county_name, " fiscal court"))
  
```

```{r}
census_county_2020 %>% 
  #filter(state.abb == "NM") %>% 
  filter(str_detect(county_name, "anchorage"))

#GA athens-clarke county in acfrs is clarke census
```

```{r}
# join acfrs with census population by = c("state.abb", "county")
county_pop_census_acfrs <- acfrs_county_parish_borough %>% 
  select(state.abb, county_name, net_pension_liability) %>% 
  
            left_join(census_county_2020, by = c("state.abb", "county_name")) %>% 
            arrange(desc(population)) #%>% filter(is.na(population))

# --> 2552 county level entities, of which 75 do not have population data
```


```{r}
#double check davidson|jefferson
county_pop_census_acfrs %>% 
  filter(state.abb == "KY" | state.abb == "TN") %>% 
  filter(str_detect(county, "davidson|jefferson")) %>% select(state.abb, population, total_liabilities, id.y, county, census_id)
  
#write.csv(county_pop_census_acfrs, "county_pop_census_acfrs.csv")
saveRDS(county_pop_census_acfrs, "county_pop_census_acfrs.RDS")
```

The matched dataset has `r nrow(county_pop_census_acfrs)` observations/ counties. 

# County Data Analysis 

## Calculate Ratio, Per Capita

```{r}
# To map
counties_1 <- county_pop_census_acfrs %>% 
  mutate(lib_rev_ratio = (total_liabilities/revenues)*100,
         lib_per_capita = total_liabilities/population, 
         county = str_to_title(county)) %>% 
  
  #rename cols to match Jordan's original files to display on map
  rename(FIPS = id.y, 
         name = county) %>%
  
  mutate(FIPS = str_sub(FIPS, -5, -1)) %>% # FIPs is position last 5 to last
  arrange(desc(population)) %>% 
  rename(id = id.x) %>% 
  select(id, FIPS, state.name, name, population, total_liabilities, revenues, lib_rev_ratio, lib_per_capita, state.abb) %>% arrange(desc(population)) 

```

## Special cases: Combined city/ county government

Some cities are counties. Need to extract the data of cities list to add new rows in counties list. 

*Jacksonville city, FL  = Duval County, FL

*San Francisco city, CA = San Francisco County, CA

*"City and County of Denver" = "Denver County"

*"Philadelphia" = "Philadelphia County"

*"Indianapolis" = "Indianapolis-Marion County"

```{r}
acfrs_city_pop <- readRDS("acfrs_city_pop.RDS") # produced from city_gov.Rmd

##Jacksonville city, FL  = Duval County, FL 
# copy the data for Jacksonville city, FL to a new row in the County data for Duval County, FL
jacksonville_duval <- acfrs_city_pop %>% 
filter(state.abb == "FL" & name == "Jacksonville") %>% 
  # adding FIPS code manually
  mutate(FIPS = "12031", # got it here https://www.census.gov/quickfacts/fact/table/duvalcountyflorida,US/PST045221
      name = "Duval County")
  
## San Francisco city, CA = San Francisco County, CA
sanfrancisco <- acfrs_city_pop %>% 
filter(state.abb == "CA" & name == "San Francisco") %>% 
  mutate(FIPS = "06075",
         name = "San Francisco County")

#Denver, CO
denver <- acfrs_city_pop  %>% 
filter(state.abb == "CO" & name == "City and County of Denver") %>%
  mutate(FIPS = "08031",
         name = "Denver County")

#Philadelphia, PA
philadelphia <- acfrs_city_pop %>% 
filter(state.abb == "PA" & name == "Philadelphia") %>% 
  mutate(FIPS = "42101", 
         name =  "Philadelphia County")
         
#Indianapolis-Marion County, Indiana
indianapolis_marion <- acfrs_city_pop %>% 
filter(state.abb == "IN" & name == "Indianapolis") %>% 
  mutate(FIPS = "1836003", # Indianapolis city (balance), Indiana
         name = "Indianapolis-Marion County")

```


```{r}
# Rbind the special cases
acfrs_counties <- rbind(jacksonville_duval, 
                  sanfrancisco,
                  denver,
                  philadelphia,
                  indianapolis_marion) %>% 
  #mutate(id.x = NA) %>% 
  mutate(lib_rev_ratio = (total_liabilities/revenues)*100,
         lib_per_capita = total_liabilities/population) %>% 
  select(id, FIPS, state.name, name, population, total_liabilities, revenues, lib_rev_ratio, lib_per_capita, state.abb) %>% 

# rbind to the rest of counties
  rbind(counties_1)
  
  
#re check all special cases: 
acfrs_counties  %>% 
  filter(name == "Duval County" |
                      name == "San Francisco County" |
                      #name == "Denver County" |
                      name == "Philadelphia County" |
                      name == "Indianapolis-Marion County" |
                      name == "Louisville-Jefferson County" |
                      name == "Nashville-Davidson County"
                      ) %>% 
  filter(state.name != "Texas") # not Duval in TX

# check other cases if they all have pop data: Kaua‘i County, HI; Dekalb County, AL; Desoto County, FL; St Francis County, AR
acfrs_counties %>% 
  filter(str_detect(name, "Kauai|Dekalb|Desoto|Francis"))

saveRDS(counties, "counties.RDS")
write.csv(counties, "counties.csv")


acfrs_counties %>% arrange(desc(population)) %>% slice(1:10) -> top10_county
#top10_county%>% write.csv("top_10_county_2020.csv")

readRDS("data/data_from_dbsite_2021.RDS") %>% 
  filter(id %in% top10_county$id) #%>% write.csv("top_10_county_2021.csv")


all_counties <- all_counties %>% 
  mutate(FIPS = str_extract(id, "US.*"),
         FIPS = str_remove_all(FIPS, "US")
         ) %>% 
  filter(!str_detect(county, "cdp"))

# check duplicated
all_counties %>% select (FIPS) %>%  group_by_all() %>%
  filter(n()>1) %>%
  ungroup() 

```


